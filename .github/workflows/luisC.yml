name: pull-request-analysis-<Luis-Carrasquilla>

on:
  push:
    paths: './'
    branches:
      - master
      - feature**
    

  pull_request:
    paths: './'
    branches:
      - master
      - feature**
jobs:   
  analysis:
    runs-on: ubuntu-latest
    steps:

      - name: Analizar el código
        run: echo "Realizando análisis de SAST"
    
      - name: Añadir cambios al repositorio
        run: |
           git config --global user.email "luis.carrasquilla.z@gmail.com"
           git config --global user.name "lucaza21"

      - name: Verificar la rama actual
        uses: actions/checkout@master
        with:
            path: master
        
      - name: Check file existence
        id: check_files
        uses: andstor/file-existence-action@v3
        with:
          files: "README.md"
  
      - name: File exists
        run: |
            if [ -f "README.md" ]; then
                echo "El archivo README.md existe en el directorio raízzzzzzzzzzzzzzzzzzzzz."
            else
                echo "El archivo README.md no existe en el directorio raíz."
            fi
        
      - name: Comprobar cumplimiento de requisitos
        id: check_requirements
        run: |
          if [ -f "allow_pull_request.txt" ]; then
            echo "El archivo 'allow_pull_request.txt' existe. Permitiendo Pull Request. True"
            echo "::set-output name=allow_pull::true"
          else
            echo "El archivo 'allow_pull_request.txt' no existe. Impidiendo Pull Request. False"
            echo "::set-output name=allow_pull::false"
            exit 1
          fi
      - name: Guardar allow_pull_request.txt como artefacto
        if: ${{ always() }}
        uses: actions/upload-artifact@v2
        with:
          name: allow_pull_request
          path: allow_pull_request.txt

  allow_build:
    runs-on: ubuntu-latest
    needs: analysis
    steps:
      - name: Permitir build si allow_pull es True
        if: ${{ needs.analysis.outputs.allow_pull == 'true' }}
        run: echo "Permitiendo Pull Request"
  prevent_build:
    runs-on: ubuntu-latest
    needs: analysis
    steps:
      - name: Impedir build si allow_pull es False
        if: ${{ needs.analysis.outputs.allow_pull == 'false' }}
        run: |
          echo "Build fallida. Impidiendo Pull Request"
          exit 1

                        

                  